import { describe, expect, it } from 'vitest'
import type { PackageVulnerabilities } from '../../shared/types'
import {
  getVulnerabilityTooltip,
  getVulnerabilitySeverityClass,
} from '../../app/composables/useVulnerableDependencies'

const mockVulnerabilities: PackageVulnerabilities = {
  package: 'test-pkg',
  version: '1.0.0',
  vulnerabilities: [
    {
      id: 'GHSA-1234',
      summary: 'Test vuln 1',
      severity: 'critical',
      aliases: ['CVE-2024-1234'],
      url: 'https://example.com/1',
    },
    {
      id: 'GHSA-5678',
      summary: 'Test vuln 2',
      severity: 'high',
      aliases: [],
      url: 'https://example.com/2',
    },
  ],
  counts: { total: 2, critical: 1, high: 1, moderate: 0, low: 0 },
}

describe('vulnerability helpers', () => {
  describe('getVulnerabilityTooltip', () => {
    it('formats single vulnerability correctly', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [
          { id: 'GHSA-1234', summary: 'Test', severity: 'high', aliases: [], url: '' },
        ],
        counts: { total: 1, critical: 0, high: 1, moderate: 0, low: 0 },
      }
      const tooltip = getVulnerabilityTooltip(info)
      expect(tooltip).toContain('1 vulnerability')
      expect(tooltip).toContain('1 high')
      expect(tooltip).toContain('GHSA-1234')
    })

    it('formats multiple vulnerabilities correctly', () => {
      const tooltip = getVulnerabilityTooltip(mockVulnerabilities)
      expect(tooltip).toContain('2 vulnerabilities')
      expect(tooltip).toContain('1 critical')
      expect(tooltip).toContain('1 high')
    })

    it('includes vulnerability IDs in tooltip', () => {
      const tooltip = getVulnerabilityTooltip(mockVulnerabilities)
      expect(tooltip).toContain('GHSA-1234')
      expect(tooltip).toContain('GHSA-5678')
    })

    it('limits IDs to 3', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [
          { id: 'GHSA-1', summary: '', severity: 'low', aliases: [], url: '' },
          { id: 'GHSA-2', summary: '', severity: 'low', aliases: [], url: '' },
          { id: 'GHSA-3', summary: '', severity: 'low', aliases: [], url: '' },
          { id: 'GHSA-4', summary: '', severity: 'low', aliases: [], url: '' },
        ],
        counts: { total: 4, critical: 0, high: 0, moderate: 0, low: 4 },
      }
      const tooltip = getVulnerabilityTooltip(info)
      expect(tooltip).toContain('GHSA-1')
      expect(tooltip).toContain('GHSA-2')
      expect(tooltip).toContain('GHSA-3')
      expect(tooltip).not.toContain('GHSA-4')
    })

    it('handles all severity levels', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 10, critical: 2, high: 3, moderate: 4, low: 1 },
      }
      const tooltip = getVulnerabilityTooltip(info)
      expect(tooltip).toContain('2 critical')
      expect(tooltip).toContain('3 high')
      expect(tooltip).toContain('4 moderate')
      expect(tooltip).toContain('1 low')
    })

    it('excludes zero counts from breakdown', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 1, critical: 0, high: 0, moderate: 1, low: 0 },
      }
      const tooltip = getVulnerabilityTooltip(info)
      expect(tooltip).not.toContain('critical')
      expect(tooltip).not.toContain('high')
      expect(tooltip).toContain('moderate')
      expect(tooltip).not.toContain('low')
    })
  })

  describe('getVulnerabilitySeverityClass', () => {
    it('returns critical color for critical severity', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 1, critical: 1, high: 0, moderate: 0, low: 0 },
      }
      expect(getVulnerabilitySeverityClass(info)).toContain('red')
    })

    it('returns high color for high severity', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 1, critical: 0, high: 1, moderate: 0, low: 0 },
      }
      expect(getVulnerabilitySeverityClass(info)).toContain('orange')
    })

    it('returns moderate color for moderate severity', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 1, critical: 0, high: 0, moderate: 1, low: 0 },
      }
      expect(getVulnerabilitySeverityClass(info)).toContain('yellow')
    })

    it('returns low color for low severity', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 1, critical: 0, high: 0, moderate: 0, low: 1 },
      }
      expect(getVulnerabilitySeverityClass(info)).toContain('blue')
    })

    it('prioritizes highest severity', () => {
      const info: PackageVulnerabilities = {
        package: 'pkg',
        version: '1.0.0',
        vulnerabilities: [],
        counts: { total: 10, critical: 1, high: 5, moderate: 3, low: 1 },
      }
      expect(getVulnerabilitySeverityClass(info)).toContain('red')
    })
  })
})
